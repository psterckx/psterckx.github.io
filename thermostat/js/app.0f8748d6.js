(function(t){function e(e){for(var a,n,o=e[0],u=e[1],l=e[2],d=0,h=[];d<o.length;d++)n=o[d],Object.prototype.hasOwnProperty.call(r,n)&&r[n]&&h.push(r[n][0]),r[n]=0;for(a in u)Object.prototype.hasOwnProperty.call(u,a)&&(t[a]=u[a]);c&&c(e);while(h.length)h.shift()();return i.push.apply(i,l||[]),s()}function s(){for(var t,e=0;e<i.length;e++){for(var s=i[e],a=!0,o=1;o<s.length;o++){var u=s[o];0!==r[u]&&(a=!1)}a&&(i.splice(e--,1),t=n(n.s=s[0]))}return t}var a={},r={app:0},i=[];function n(e){if(a[e])return a[e].exports;var s=a[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=a,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(s,a,function(e){return t[e]}.bind(null,a));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/thermostat/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],u=o.push.bind(o);o.push=e,o=o.slice();for(var l=0;l<o.length;l++)e(o[l]);var c=u;i.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("56d7")},"034f":function(t,e,s){"use strict";s("85ec")},"56d7":function(t,e,s){"use strict";s.r(e);var a=s("2b0e"),r=s("8c4f"),i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"m-4 mt-5",attrs:{id:"app"}},[s("div",{staticClass:"container"},[s("div",{staticClass:"row"},[s("div",{staticClass:"col-12 text-center fs-1",class:{"fw-bold":t.delta}},[t._v(" "+t._s(t.isAuthTokenValid?t.delta?t.userDesiredTemperature:t.state?t.state.reported.thermostat_temperature:"??":"??")+" ")]),s("div",{staticClass:"col-12 text-center mb-2"},[t._v("set temperature")]),s("div",{staticClass:"col-12 text-center fs-3"},[t._v(" "+t._s(t.isAuthTokenValid&&t.state&&t.state.reported.measured_temperature?Math.round(t.state.reported.measured_temperature):"??")+" ")]),s("div",{staticClass:"col-12 text-center mb-5"},[t._v("measured temperature")]),s("div",{staticClass:"col-5 offset-1 text-center"},[s("button",{staticClass:"btn btn-secondary w-100",attrs:{type:"button",disabled:t.isRequestInFlight||t.inErrorState||!t.isDeviceOnline},on:{click:function(e){return t.updateUserDesiredTemperature(-1)}}},[t._v(" decrease ")])]),s("div",{staticClass:"col-5 text-center mb-2"},[s("button",{staticClass:"btn btn-secondary w-100",attrs:{type:"button",disabled:t.isRequestInFlight||t.inErrorState||!t.isDeviceOnline},on:{click:function(e){return t.updateUserDesiredTemperature(1)}}},[t._v(" increase ")])]),s("div",{staticClass:"col-10 offset-1 text-center mb-2"},[s("button",{staticClass:"btn w-100",class:{"btn-secondary":!t.delta,"btn-success":t.delta},attrs:{type:"button",disabled:!(t.delta&&!t.isRequestInFlight)||t.inErrorState||!t.isDeviceOnline},on:{click:function(e){return t.flight(t.updateSetTemperature,[t.userDesiredTemperature])}}},[t._v(" update ")])]),s("div",{staticClass:"col-10 offset-1 text-center mb-5"},[s("button",{staticClass:"btn btn-primary w-100",attrs:{type:"button",disabled:t.isRequestInFlight||!t.isAuthTokenValid},on:{click:function(e){return t.flight(t.getDeviceShadowState)}}},[t._v(" refresh ")])]),s("div",{staticClass:"col-12 text-center d-flex justify-content-center mb-5"},[s("span",{staticClass:"dot mx-2",class:{"device-online":t.isDeviceOnline,"device-state-unknown":!t.isAuthTokenValid}}),s("span",[t._v(" "+t._s(t.isAuthTokenValid?t.isDeviceOnline?"Device online":"Device offline":"Device state unknown")+" ")])]),s("div",{staticClass:"col-12 text-center d-flex justify-content-center"},[s("span",{staticClass:"input-group-text",attrs:{id:"basic-addon1"}},[t._v("token")]),s("input",{directives:[{name:"model",rawName:"v-model",value:t.authToken,expression:"authToken"}],staticClass:"form-control",class:[t.isAuthTokenValid?"is-valid":t.authToken.length>0?"is-invalid":""],attrs:{type:"text",placeholder:"",disabled:t.isAuthTokenValid},domProps:{value:t.authToken},on:{input:function(e){e.target.composing||(t.authToken=e.target.value)}}})])])])])},n=[],o=s("bc3a"),u=s.n(o),l={name:"App",data(){return{userDesiredTemperature:null,measuredTemperature:null,state:null,metadata:null,isRequestInFlight:!1,inErrorState:!1,authToken:"",isAuthTokenValid:!1}},computed:{delta(){return!!this.state&&!(this.state.desired.thermostat_temperature===this.userDesiredTemperature)},timeout(){return 4e3+1200*Math.abs(this.state.reported.thermostat_temperature-this.userDesiredTemperature)},isDeviceOnline(){if(this.state){const t=1e3*this.metadata.reported.thermostat_temperature.timestamp;if(Date.now()-t<9e5)return!0}return!1}},watch:{async authToken(t){if(36===t.length)try{await this.flight(this.retry,[this.getDeviceShadowState,1]),this.userDesiredTemperature=this.state.desired.thermostat_temperature,this.isAuthTokenValid=!0}catch(e){this.isAuthTokenValid=!1,console.log(e)}}},methods:{async flight(t,e){console.log("in flight"),this.isRequestInFlight=!0;const s=await t.apply(this,e);return console.log("landed"),this.isRequestInFlight=!1,s},updateUserDesiredTemperature(t){this.userDesiredTemperature+=t,console.log(this.$route)},async updateSetTemperature(t){const e={method:"post",url:"https://vh3rmjhs10.execute-api.us-east-1.amazonaws.com/test/thermostat/state",headers:{authorization:this.authToken,"Content-Type":"application/json"},data:{state:{desired:{thermostat_temperature:t}}}};try{await u()(e)}catch(s){console.log(s)}await this.wait(this.timeout);try{await this.retry(this.getDeviceShadowState,1)}catch(s){console.log(s)}},async getDeviceShadowState(){console.log("getDeviceShadowState");const t={method:"get",url:"https://vh3rmjhs10.execute-api.us-east-1.amazonaws.com/test/thermostat/state",headers:{authorization:this.authToken,"Content-Type":"application/json"}};let e;try{e=await u()(t)}catch(s){throw new Error("API call failed")}if(this.state=e.data.state,this.metadata=e.data.metadata,this.userDesiredTemperature=this.state.reported.thermostat_temperature,this.state.delta)throw this.inErrorState=!0,new Error("State has delta");this.inErrorState=!1,console.log("refresh compelete")},async retry(t,e){for(let a=0;a<e;a++){console.log("retry");try{return await t.call()}catch(s){console.log(s),await this.wait(this.timeout)}}throw this.inErrorState=!0,new Error("Retry maxed out - something is wrong")},wait(t){return new Promise(e=>setTimeout(e,t))}},async beforeMount(){setInterval(()=>{if(this.isAuthTokenValid&&!this.isRequestInFlight)try{this.getDeviceShadowState()}catch(t){console.log(t)}},3e5)},mounted(){this.$route.query.t&&(this.authToken=this.$route.query.t)}},c=l,d=(s("034f"),s("2877")),h=Object(d["a"])(c,i,n,!1,null,null,null),p=h.exports;s("ab8b");a["a"].use(r["a"]),a["a"].config.productionTip=!1;const m=new r["a"]({mode:"history"});new a["a"]({router:m,render:t=>t(p)}).$mount("#app")},"85ec":function(t,e,s){}});
//# sourceMappingURL=app.0f8748d6.js.map